<!DOCTYPE html>
<html>
  <head>
    <!-- Import Vega & Vega-Lite (does not have to be from CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/vega@5.20.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.1.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.17.0"></script>

    <!-- D3 JS Source -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <!-- CSS file -->
    <link rel="stylesheet" type="text/css" href="css/styles.css" media="all" />

    <!-- Google Font (Noto Semibold 600) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@600&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container" style="margin-top: 50px">
      <h1 class="title">2019 Australian Bushfires</h1>
      <div class="visualisation" style="margin-bottom: 30px">
        <div id="symbol_map"></div>
        <div id="line_graph"></div>
      </div>
      <div class="info-panel">
        <h2 class="subtitle">Bushfire Information</h2>
        <div class="info-item"><label>Date:</label><span id="date"></span></div>
        <div class="info-item">
          <label>Latitude:</label><span id="latitude"></span>
        </div>
        <div class="info-item">
          <label>Longitude:</label><span id="longitude"></span>
        </div>
        <div class="info-item">
          <label>Brightness:</label><span id="brightness"></span>
        </div>
        <div class="info-item">
          <label>Control:</label>
          <button id="toggleAnimation">Pause</button>
          <!-- Pause/Play Button -->
        </div>
        <!-- Slider input for animation speed -->
        <div class="slider wrapper">
          <label>Animation Speed:</label>
          <input
            id="animationSpeed"
            type="range"
            min="50"
            max="1000"
            value="250"
            step="10"
          />
          <span id="speedDisplay">250ms = 1 day</span>
        </div>
        <div class="info-item">
          <label>Select Date:</label>
          <input
            type="date"
            id="datePicker"
            min="2019-09-01"
            max="2019-12-31"
          />
          <!-- Date Selector -->
        </div>
      </div>
    </div>
    <script type="text/javascript">
      const spec = "js/symbol_map.vg.json";
      const spec2 = "js/line_graph.vg.json";

      function updateLineGraph(latitude, longitude) {
        d3.csv("../data/fire_archive.csv").then((data) => {
          const filteredData = data.filter(
            (d) =>
              Math.abs(+d.latitude - latitude) < 2 &&
              Math.abs(+d.longitude - longitude) < 2
          );

          d3.json("js/line_graph.vg.json").then((lineGraphSpec) => {
            lineGraphSpec.data = { values: filteredData };
            vegaEmbed("#line_graph", lineGraphSpec);
          });
        });
      }

      let currentDateOffset = 0;
      vegaEmbed("#symbol_map", spec, {
        patch: (spec) => {
          spec.signals.push({
            name: "mapClick",
            value: 0,
            on: [{ events: "mousedown", update: "datum" }],
          });
          return spec;
        },
      })
        .then((result) => {
          result.view.addSignalListener("mapClick", (_, v) => {
            if (v == undefined || ["type"] == "Feature") {
              console.log(v["latitude"]);
            } else {
              document.getElementById("date").textContent = v["formattedDate"];
              document.getElementById("latitude").textContent = v["latitude"];
              document.getElementById("longitude").textContent = v["longitude"];
              document.getElementById("brightness").textContent =
                v["brightness"];
              updateLineGraph(v["latitude"], v["longitude"]);
            }
          });

          let lastUpdate = Date.now();
          let tickRate = 250;

          // Function to update the tickRate based on user input
          document
            .getElementById("animationSpeed")
            .addEventListener("input", function () {
              tickRate = this.value;
              document.getElementById("speedDisplay").textContent =
                tickRate + "ms = 1 day";
            });

          let isPlaying = true; // Default state is playing

          document
            .getElementById("toggleAnimation")
            .addEventListener("click", function () {
              isPlaying = !isPlaying; // Toggle the play state
              if (isPlaying) {
                this.textContent = "Pause"; // Update button text
                animate(); // Start the animation
              } else {
                this.textContent = "Play"; // Update button text
              }
            });

          // Update for the Date Selector
          document
            .getElementById("datePicker")
            .addEventListener("change", function () {
              const selectedDate = new Date(this.value);
              const baseDate = new Date("2019-09-01");
              currentDateOffset = Math.floor(
                (selectedDate - baseDate) / (1000 * 60 * 60 * 24)
              ); // Convert date difference to days
              result.view.signal("currentDateOffset", currentDateOffset).run();
            });

          function animate() {
            if (isPlaying) {
              let now = Date.now();
              let elapsed = now - lastUpdate;

              // Update every 1000ms
              if (elapsed > tickRate) {
                lastUpdate = now;

                if (currentDateOffset == 120) {
                  currentDateOffset = 0;
                }
                currentDateOffset += 1;
                result.view
                  .signal("currentDateOffset", currentDateOffset)
                  .run();
              }

              // Use requestAnimationFrame for smoother animations
              requestAnimationFrame(animate);
            }
          }
          animate();
        })
        .catch(console.error);
    </script>
  </body>
</html>
